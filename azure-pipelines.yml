# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  branches:
    include:
      - master

pr:
  branches:
    include:
      - master

variables:
- group: var-group # Підключення Variable Group

stages:
  - stage: Build
    displayName: "Build Docker Image"
    jobs:
      - job: Build
        displayName: "Build Docker Image"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          # Checkout the repository
          - checkout: self
            displayName: "Checkout the repository"

          # Print variables for debugging
          - script: printenv
            displayName: "Print all environment variables"

          # Login to Docker Hub
          - script: |
              echo "$(DOCKER_PASSWORD)" | docker login -u "$(DOCKER_USERNAME)" --password-stdin
            displayName: "Login to Docker Hub"

          # Build Docker image
          - script: |
              docker build -t ${imageName}:${tag} .
            displayName: "Build Docker Image"

          # Push Docker image to Docker Hub
          - script: |
              docker push ${imageName}:${tag}
            displayName: "Push Docker Image"

  - stage: Deploy
    displayName: "Deploy to Azure"
    dependsOn: Build
    jobs:
      - job: Deploy
        displayName: "Deploy to Azure App Service"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          # Login to Azure and deploy Docker Image
          - task: AzureCLI@2
            inputs:
              azureSubscription: "aspnet-azure-connection" # Змініть на правильну назву
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az webapp config container set \
                  --name $(app_service_name) \
                  --resource-group $(azurerm_resource_group_name) \
                  --docker-custom-image-name $(imageName):$(tag) \
                  --docker-registry-server-url https://index.docker.io/v1/





